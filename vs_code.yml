---
- hosts: localhost
  connection: local
  become: false

  pre_tasks:
  - name: Ensuring Homebrew Is Installed
    stat:
      path: /opt/homebrew/bin/brew
    register: homebrew_check

  - name: Fail if homebrew is not installed and install_homebrew_if_missing is False
    fail: 
      msg: Homebrew is missing...Install from https://brew.sh/
    when:
      - not homebrew_check.stat.exists
      - not install_homebrew_if_missing

  - name: Installing Homebrew
    shell: /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
    when:
      - not homebrew_check.stat.exists
      - install_homebrew_if_missing 

  tasks:
  - name: Updating Homebrew
    homebrew:
      update_homebrew: true
      upgrade: true
    when: homebrew_check.stat.exists
  
  - name: Install core packages via brew casks
    community.general.homebrew_cask:
      name: visual-studio-code
      state: present
      accept_external_apps: true

  - name: Install Extensions
    shell: code --install-extension {{ item }}
    register: code_extension
    changed_when: "'was successfully installed' in code_extension.stdout"
    with_items:
    - bierner.markdown-mermaid
    - bmewburn.vscode-intelephense-client
    - bradlc.vscode-tailwindcss
    - breezelin.phpstan
    - chouzz.vscode-better-align
    - DavidAnson.vscode-markdownlint
    - DotJoshJohnson.xml
    - eamodio.gitlens
    - EditorConfig.EditorConfig
    - formulahendry.auto-close-tag
    - formulahendry.auto-rename-tag
    - GitHub.codespaces
    - GitHub.github-vscode-theme
    - hashicorp.terraform
    - jebbs.plantuml
    - johnbillion.vscode-wordpress-hooks
    - mohd-akram.vscode-html-format
    - ms-python.python
    - ms-python.vscode-pylance
    - ms-vscode-remote.remote-containers
    - ms-vsliveshare.vsliveshare
    - naumovs.color-highlight
    - neilbrayfield.php-docblocker
    - phproberto.vscode-php-getters-setters
    - PKief.material-icon-theme
    - redhat.vscode-yaml
    - sdras.night-owl
    - SimonSiefke.svg-preview
    - SimplyDanny.modelica
    - streetsidesoftware.code-spell-checker
    - Tyriar.sort-lines
    - valeryanm.vscode-phpsab
    - vincaslt.highlight-matching-tag
    - Vue.volar
    - wayou.vscode-todo-highlight
    - whatwedo.twig
    - xdebug.php-debug

  - name: Move VS Code Config
    copy:
      src: ./files/vs-code-settings.json
      dest: /Users/{{ lookup('env', 'USER') }}/Library/Application Support/Code/User/settings.json
      owner: "{{ lookup('env', 'USER') }}"
      force: yes

  - name: Ensure target directory exists
    file:
      path: /Users/{{ lookup('env', 'USER') }}/Library/Application Support/Code/User/snippets/
      state: directory
      mode: '0755'

  - name: Move VS Code Snippets
    copy:
      src: ./files/vs-code-snippets.code-snippets
      dest: /Users/{{ lookup('env', 'USER') }}/Library/Application Support/Code/User/snippets/myGlobal.code-snippets
      owner: "{{ lookup('env', 'USER') }}"
      force: yes

  - name: Ensure iTerm2 color schemes directory exists
    file:
      path: ~/Library/Application\ Support/iTerm2/Color\ Schemes
      state: directory
      mode: '0755'

  - name: Copy .itermcolors file to target directory
    copy:
      src: files/cobalt2.itermcolors
      dest: ~/Library/Application\ Support/iTerm2/Color\ Schemes/cobalt2.itermcolors
      mode: '0644'

  - name: Import .itermcolors file into iTerm2
    shell: >
      osascript -e 'tell application "iTerm2"
        set colorFile to POSIX file "~/Library/Application Support/iTerm2/Color Schemes/cobalt2.itermcolors"
        load color preset colorFile
      end tell'